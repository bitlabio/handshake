function page(s){state.url=s,window.history.pushState(state,state.url,state.url),render()}function hideall(){$("#name").blur(),$("#logo").hide(),$("#sloganblock").hide(),$("#signupbuttonblock").hide(),$("#managerlink").hide(),$("#mapblock").hide(),$("#profile").hide(),$("#profileEmail").hide(),$("#profileLocation").hide(),$("#profileType").hide(),$("#profileSkills").hide(),$("#messageBox").hide(),$("#success").hide(),$("#postJob").hide(),$("#postJobResults").hide()}function renderHome(){console.log("Render: home page"),state.url="/",window.history.pushState(state,"Home","/"),$("#logo").show(),console.log(userdata),1==userdata.signedup?($(".namedisplay").html(userdata.name),$(".locationdisplay").html(userdata.city+", "+userdata.country),$("#profileType").fadeIn(),$("#profilenextTypeWorker").unbind().click(function(){userdata.usertype="worker",page("/profile/skills")}),$("#hirepeople").unbind().click(function(){userdata.usertype="contractor",page("/postjob")})):($("#sloganblock").show(),$("#signupbuttonblock").show()),$("#logo").click(function(){console.log("click logo :)"),"/"!=state.url}),$("#signupbutton").unbind().click(function(){state.url="/profile",window.history.pushState(state,"Set Name","/profile"),render()})}function renderProfile(){state.url="/profile",$("#profile").fadeIn(),$("#name").focus(),$("#profilenext").unbind().click(function(){userdata.name=$("#name").val(),console.log(userdata),state.url="/profile/email",window.history.pushState(state,"Set Email","/profile/email"),render()})}function renderProfileEmail(){state.url="/profile/email",$("#profileEmail").fadeIn(),$("#email").focus(),$("#profilenextemail").unbind().click(function(){userdata.email=$("#email").val(),console.log(userdata),$("#profileEmail").hide(),$.ajax({url:"/api/signup",type:"POST",contentType:"application/json",data:JSON.stringify(userdata)}).done(function(s){$("#success").fadeIn(),userdata.signedup=!0,setTimeout(function(){page("/")},1e3)})})}function renderProfileLocation(){state.url="/profile/location",$("#profileLocation").fadeIn(),$("#location").focus(),userdata.gpslookup&&userdata.gpslookup.city&&$("#location").val(userdata.gpslookup.city),$("#profilenextLocation").click(function(){userdata.locationCity=$("#location").val(),console.log(userdata)})}function renderProfileType(){state.url="/profile/type",$("#profileType").fadeIn(),$("#profilenextTypeWorker").click(function(){userdata.usertype="worker",page("/profile/skills")}),$("#profilenextTypeContractor").click(function(){userdata.usertype="contractor",page("/postjob")})}function skillreclist(){var s="";for(var e in skillsdb){var l=skillsdb[e][3];1==l&&(s+='<span class="skillreq" data-id="'+e+'" style="color: #f6b727; opacity: 1">'+skillsdb[e][0]+" "+skillsdb[e][1]+"<br>&nbsp;&nbsp;&nbsp;"+skillsdb[e][2]+"</span><br><br>"),0==l&&(s+='<span class="skillreq" data-id="'+e+'" style="color: #888; opacity: 1">'+skillsdb[e][0]+" "+skillsdb[e][1]+"<br>&nbsp;&nbsp;&nbsp;"+skillsdb[e][2]+"</span><br><br>")}$("#skillrecommend").html(s),$(".skillreq").click(function(){var s=$(this).data().id;console.log($(this).data()),0==skillsdb[s][3]?(skillsdb[s][3]=1,$(this).css("color","#f6b727;"),$(this).css("opacity","1")):(skillsdb[s][3]=0,$(this).css("color","#999")),skillreclist()}),$(".skillreq").hover(function(){$(this).css("opacity","0.75")},function(){$(this).css("opacity","1")})}function skillclickremove(){$(".skilladdedlistitem").click(function(s){var e=-1;for(var l in skillsadded)skillsadded[l]==$(this).context.textContent&&(e=l);skillsadded.splice(e,1),renderSkillsAdded()})}function renderSkillsAdded(){var s="";for(var e in skillsadded)s+='<span class="skilladdedlistitem">'+skillsadded[e]+"</span><br>";skillclickremove(),skillreclist()}function skillclick(){$(".skillreq").click(function(s){$("#skillinput").val("").focus(),skillsadded.push($(this).context.textContent),renderSkillsAdded()})}function renderProfileSkills(){$("#profileSkills").fadeIn(),skillreclist(),$("#skillinput").on("propertychange input",function(s){console.log($("#skillinput").val()),skillreclist()}),$("#skillsdone").unbind().click(function(s){console.log("done!?"),userdata.skills=skillsdb,$("#profileSkills").hide(),$("#messageBoxText").html("Uploading profile..."),$("#messageBox").fadeIn(),console.log(JSON.stringify(userdata)),$.ajax({url:"/api/skills",type:"POST",contentType:"application/json",data:JSON.stringify(userdata.skills)}).done(function(s){$("#success").fadeIn(),$("#messageBoxText").html("SKILLS UPDATED."),userdata.signedup=!0,setTimeout(function(){page("/")},2e3)})})}function renderPostJob(){$("#postJob").fadeIn();var s="";for(var e in jobskills){var l=jobskills[e][3];1==l&&(s+='<span class="jobskillreq" data-id="'+e+'" style="color: #f6b727; opacity: 1">'+jobskills[e][0]+" "+jobskills[e][1]+"<br>&nbsp;&nbsp;&nbsp;"+jobskills[e][2]+"</span><br><br>"),0==l&&(s+='<span class="jobskillreq" data-id="'+e+'" style="color: #888; opacity: 1">'+jobskills[e][0]+" "+jobskills[e][1]+"<br>&nbsp;&nbsp;&nbsp;"+jobskills[e][2]+"</span><br><br>")}$("#jobskills").html(s),$(".jobskillreq").click(function(){var s=$(this).data().id;console.log($(this).data()),0==jobskills[s][3]?(jobskills[s][3]=1,$(this).css("color","#f6b727;"),$(this).css("opacity","1")):(jobskills[s][3]=0,$(this).css("color","#999")),renderPostJob()}),$(".jobskillreq").hover(function(){$(this).css("opacity","0.75")},function(){$(this).css("opacity","1")}),$("#jobsearch").unbind().click(function(){$("#postJob").hide(),$("#postJobResults").fadeIn(),$("#postJobResultsTitle").html("searching..."),$("#homebutton").unbind().click(function(){page("/")}),$.ajax({url:"/api/search",type:"POST",contentType:"application/json",data:JSON.stringify(jobskills)}).done(function(s){s=JSON.parse(s),$("#postJobResultsTitle").html(s.length+" found.");var e="";for(var l in s){e+="<h4>"+s[l].name+' (<a href="mailto:'+s[l].email+'">'+s[l].email+"</a>)</h4>";var o=0,i=0,t=0;for(var a in s[l].skills)1==s[l].skills[a][3]&&i++;for(var n in jobskills){1==jobskills[n][3]&&t++;for(var a in s[l].skills)jobskills[n][1]==s[l].skills[a][1]&&1==jobskills[n][3]&&1==s[l].skills[a][3]&&o++}e+='<span style="font-size:9.5px;">';var r=Math.round(o/t*100);1==isNaN(r)&&(r=100),e+=r+"% match - "+s[l].city+", "+s[l].country+"<br>",e+="</span>",e+="<br><br>"}$("#foundpersons").html(e)})})}function getAbsolutePath(){var s=window.location,e=s.pathname.substring(0,s.pathname.lastIndexOf("/")+1);return s.href.substring(0,s.href.length-((s.pathname+s.search+s.hash).length-e.length))}function getStateUrl(){var s=(getAbsolutePath().length,""+document.location),e=s.slice(s.indexOf("://")+3);e.indexOf(":")>=0&&console.log("non standard port!");var l=e.slice(e.indexOf("/"));return l}function render(){hideall(),console.log("render "+state.url),"/"==state.url&&renderHome(),"/postjob"==state.url&&renderPostJob(),"/profile"==state.url&&renderProfile(),"/profile/email"==state.url&&renderProfileEmail(),"/profile/location"==state.url&&renderProfileLocation(),"/profile/type"==state.url&&renderProfileType(),"/profile/skills"==state.url&&renderProfileSkills()}var skillsdb=[];skillsdb.push(["&nbsp;&nbsp;","VOC","",0]),skillsdb.push(["&nbsp;&nbsp;","RIIVEH304D","Conduct Tip Truck Operations",0]),skillsdb.push(["LR","RIIMPO317D","Conduct Roller Operations",0]),skillsdb.push(["LS","RIIMPO318E","Conduct Skid Steer Operations",0]),skillsdb.push(["LB","RIIMPO319D","Conduct Backhoe Loader Operations",0]),skillsdb.push(["LE","RIIMPO320E","Conduct Excavator Operations",0]),skillsdb.push(["LL","RIIMPO321E","Conduct Wheeled Loader Operations",0]),skillsdb.push(["&nbsp;&nbsp;","RIIMPO322D","Conduct Tracked Loader Operations",0]),skillsdb.push(["LZ","RIIMPO323D","Conduct Dozer Operations",0]),skillsdb.push(["LG","RIIMPO324E","Conduct Grader Operations",0]),skillsdb.push(["LP","RIIMPO325D","Conduct Scraper Operations",0]),skillsdb.push(["&nbsp;&nbsp;","RIIMPO326D","Conduct Water Cart Operations",0]);var state={url:"/"},userdata={};userdata.name="",userdata.email="",userdata.location={},userdata.ip="",userdata.skills=[];var skillsadded=[],jobskills=[];for(var a in skillsdb)jobskills[a]=skillsdb[a],jobskills[a][3]=0;$(document).ready(function(){hideall(),$("#wrapper").fadeIn(),console.log("handshake app loading.."),console.log("requesting session information"),$.ajax({url:"/api/session",type:"GET",success:function(s){s=JSON.parse(s),console.log("ip:"+JSON.stringify(s.ip)),userdata.ip=s.ip,console.log(s.db),null==s.db?userdata.signedup=!1:(userdata.name=s.db.name,userdata.signedup=!0,userdata.db=s.db,userdata.name=s.db.name,userdata.country=s.db.country,userdata.city=s.db.city,s.db.skills.length>0&&(skillsdb=s.db.skills)),render()}}),console.log("requesting location information"),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(s){userdata.geolocation={},userdata.geolocation.accuracy=s.coords.accuracy,userdata.geolocation.lat=s.coords.latitude,userdata.geolocation.lon=s.coords.longitude,$.ajax({url:"/api/gpslookup",type:"POST",contentType:"application/json",data:JSON.stringify(userdata)}).done(function(s){userdata.gpslookup=s,userdata.city=s.city,userdata.country=s.country,console.log(userdata),""==$("#location").val()&&$("#location").val(userdata.gpslookup.city)})}),$.ajax({url:"/api/location",type:"GET",success:function(s){console.log("location:"+JSON.stringify(s)),userdata.location=s}});var s=getStateUrl();""!=s?state.url=s:s="/",null!=history.state&&(state=history.state),window.onpopstate=function(s){console.log("location: "+document.location+", state: "+JSON.stringify(s.state)),s.state.url&&(state=s.state),render()}});